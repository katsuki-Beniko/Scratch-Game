<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch to Reveal</title>
    <link rel="stylesheet" href="./style.css">
    <script type="module">
    import { HiddenImageSrc, CoverImageSrc, CongratsImageSrc, eraseTimeoutDuration, resetTimeoutDuration, CoverSizeWidth, CoverSizeHeight, threshold, coverPositionX, coverPositionY, congratulationSizeWidth, congratulationSizeHeight, congratulationPositionX, congratulationPositionY } from './getimage.js';

    document.addEventListener("DOMContentLoaded", function () {
    const canvasBackground = document.getElementById("backgroundCanvas");
    const ctxBackground = canvasBackground.getContext("2d");

    const canvasCover = document.getElementById("coverCanvas");
    const ctxCover = canvasCover.getContext("2d");

    const blueSquareImage = new Image();
    const coverImage = new Image();
    const congratsImage = new Image();

    let isDrawing = false;
    let eraseStarted = false;
    let eraseComplete = false;
    const container = document.getElementById("canvas-container");

    const containerWidth = container.offsetWidth;
    const containerHeight = container.offsetHeight;

    let eraseImageTimer;
    let resetGameTimer;

    canvasBackground.width = containerWidth;
    canvasBackground.height = containerHeight;
    const dpr = window.devicePixelRatio || 1;
canvasCover.width = containerWidth * dpr;
canvasCover.height = containerHeight * dpr;
ctxCover.scale(dpr, dpr);

    // Load the cover image first
    function loadCoverImage() {
        coverImage.src = CoverImageSrc;
        coverImage.onload = () => {
            ctxCover.globalCompositeOperation = "source-over";
            ctxCover.drawImage(coverImage, coverPositionX, coverPositionY, CoverSizeWidth, CoverSizeHeight);
            loadHiddenImage();
        };
    }

    // Load the hidden image (background)
    function loadHiddenImage() {
        blueSquareImage.src = HiddenImageSrc;
        blueSquareImage.onload = () => {
            ctxBackground.drawImage(blueSquareImage, coverPositionX, coverPositionY, canvasBackground.width, canvasBackground.height);
        };
    }

    // Load the congratulations image
    function loadCongratsImage() {
        congratsImage.src = CongratsImageSrc;
        congratsImage.onload = () => {
            ctxCover.globalCompositeOperation = "source-over";
            ctxCover.clearRect(0, 0, canvasCover.width, canvasCover.height);
            ctxCover.drawImage(congratsImage, congratulationPositionX, congratulationPositionY, congratulationSizeWidth, congratulationSizeHeight);
        };
    }

    loadCoverImage();

        // Handle mouse and touch events
        function getPosition(e) {
            const rect = canvasCover.getBoundingClientRect();
            const scaleX = canvasCover.width / rect.width;
            const scaleY = canvasCover.height / rect.height;

            if (e.touches) { // Mobile touch events
                const touch = e.touches[0]; // Get the first touch
                return {
                    x: (touch.clientX - rect.left) * scaleX,
                    y: (touch.clientY - rect.top) * scaleY
                };
            } else { // Mouse events
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }
        }

    function startDrawing(e) {
        if (eraseComplete) return;
        isDrawing = true;
        eraseStarted = true;
        erase(e);
        startEraseImageTimer();
    }

        function stopDrawing() {
            isDrawing = false;
            ctxCover.beginPath();  // Reset the drawing path
        }

    function erase(e) {
        if (!isDrawing || eraseComplete) return;
        clearTimeout(eraseImageTimer);
        const { x, y } = getPosition(e);
        ctxCover.lineWidth = 40;
        ctxCover.lineCap = "round";
        ctxCover.lineTo(x, y);
        ctxCover.stroke();
        ctxCover.beginPath();
        ctxCover.moveTo(x, y);
        ctxCover.globalCompositeOperation = "destination-out";
        
        checkErasedArea();
        startEraseImageTimer();
    }

    function checkErasedArea() {
        const imageData = ctxCover.getImageData(coverPositionX, coverPositionY, CoverSizeWidth, CoverSizeHeight);
        const totalPixels = imageData.width * imageData.height;
        let erasedPixels = 0;

        for (let i = 0; i < totalPixels * 4; i += 4) {
            if (imageData.data[i + 3] === 0) {
                erasedPixels++;
            }
        }

        const erasedPercentage = erasedPixels / totalPixels;

        if (erasedPercentage > threshold) {
            ctxCover.clearRect(coverPositionX, coverPositionY, CoverSizeWidth, CoverSizeHeight);
            loadCongratsImage();
            startResetGameTimer();
        }
    }

        // Support both mouse and touch events
        function handleStart(e) {
            e.preventDefault();  // Prevent scrolling on touch
            startDrawing(e);
        }

        function handleMove(e) {
            e.preventDefault();  // Prevent scrolling on touch
            if (isDrawing) {
                erase(e);  // Continuously erase while the user is dragging/touching
            }
        }

        function handleEnd(e) {
            e.preventDefault();
            stopDrawing();
        }

        canvasCover.addEventListener("mousedown", handleStart);
        canvasCover.addEventListener("mousemove", handleMove);
        canvasCover.addEventListener("mouseup", handleEnd);

        canvasCover.addEventListener("touchstart", handleStart, { passive: false });
        canvasCover.addEventListener("touchmove", handleMove, { passive: false });
       canvasCover.addEventListener("touchend", handleEnd, { passive: false });

    function startEraseImageTimer() {
        clearTimeout(eraseImageTimer);
        if (eraseStarted) {
            eraseImageTimer = setTimeout(() => {
                ctxCover.clearRect(coverPositionX, coverPositionY, CoverSizeWidth, CoverSizeHeight);
                eraseComplete = true;
                loadCongratsImage();
                startResetGameTimer();
            }, eraseTimeoutDuration);
        }
    }

    function startResetGameTimer() {
        clearTimeout(resetGameTimer);
        resetGameTimer = setTimeout(() => {
            // Reset game if needed
        }, resetTimeoutDuration);
    }
});

    </script>
</head>
<body>
    <div id="canvas-container">
        <canvas id="backgroundCanvas"></canvas>
        <canvas id="coverCanvas"></canvas>
    </div>
</body>
</html>
